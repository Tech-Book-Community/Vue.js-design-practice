---
layout: center
---

# éç†æƒ³ç‹€æ³çš„è™•ç†

<div class="mt-8 text-2xl text-gray-400">
å››æ­¥æ¯”è¼ƒéƒ½æ²’å‘½ä¸­æ€éº¼è¾¦ï¼Ÿ
</div>

<!--
å¥½ï¼Œé€™ä¸€ç¯€æˆ‘å€‘ä¾†çœ‹éç†æƒ³ç‹€æ³çš„è™•ç†ã€‚

å‰é¢å­¸çš„é›™ç«¯ Diff æœ‰å››æ­¥æ¯”è¼ƒï¼Œä½†å¦‚æœå››æ­¥éƒ½æ²’æœ‰å‘½ä¸­å‘¢ï¼Ÿé€™å°±æ˜¯æˆ‘å€‘èªªçš„éç†æƒ³ç‹€æ³ã€‚
-->

---
clicks: 4
---

# å•é¡Œï¼šå››æ­¥éƒ½æ²’å‘½ä¸­

<div class="mt--2">
  <DiffAnimationNonIdeal :clicks="$clicks" />
</div>

<div v-click="4" class="mt-2 text-center text-3xl text-red-400 font-bold">
å››æ­¥éƒ½æ²’å‘½ä¸­ï¼æ€éº¼è¾¦ï¼Ÿ
</div>

<!--
è®“æˆ‘å€‘çœ‹ä¸€å€‹ä¾‹å­ã€‚èˆŠå­ç¯€é»æ˜¯ p-1ã€p-2ã€p-3ã€p-4ï¼Œæ–°å­ç¯€é»æ˜¯ p-2ã€p-4ã€p-1ã€p-3ã€‚

è«‹é»æ“Šæˆ–æŒ‰ç©ºæ ¼éµé€æ­¥æŸ¥çœ‹å‹•ç•«ã€‚

ä½ æœƒçœ‹åˆ°ç¬¬ä¸€è¼ªæ¯”è¼ƒæ™‚ï¼Œæ­¥é©Ÿä¸€åˆ°æ­¥é©Ÿå››å…¨éƒ¨éƒ½æ²’æœ‰å‘½ä¸­ã€‚é€™å°±æ˜¯éç†æƒ³ç‹€æ³ï¼Œæˆ‘å€‘éœ€è¦é¡å¤–çš„è™•ç†æ–¹å¼ã€‚
-->

---

# è§£æ±ºæ–¹æ¡ˆï¼šåœ¨èˆŠç¯€é»ä¸­æŸ¥æ‰¾

<div class="mt-8 text-xl text-gray-300 mb-6">
æ‹¿æ–°çš„é ­éƒ¨ç¯€é» <code class="text-green-400">newStartVNode</code> å»èˆŠç¯€é»é™£åˆ—ä¸­æŸ¥æ‰¾ï¼š
</div>

<div class="bg-gray-800/50 rounded-lg p-6">

```js {all|2-5|7-14|16}{lines:true}
else {
  // å››æ­¥éƒ½æ²’å‘½ä¸­ï¼Œåœ¨èˆŠç¯€é»ä¸­æŸ¥æ‰¾
  const idxInOld = oldChildren.findIndex(
    node => node.key === newStartVNode.key
  )

  if (idxInOld > 0) {
    // æ‰¾åˆ°äº†ï¼Œç§»å‹•åˆ°é ­éƒ¨
    const vnodeToMove = oldChildren[idxInOld]
    patch(vnodeToMove, newStartVNode, container)
    insert(vnodeToMove.el, container, oldStartVNode.el)
    // æ¨™è¨˜ç‚ºå·²è™•ç†
    oldChildren[idxInOld] = undefined
  }

  newStartVNode = newChildren[++newStartIdx]
}
```

</div>

<!--
è§£æ±ºæ–¹æ¡ˆæ˜¯ï¼šæ‹¿æ–°çš„é ­éƒ¨ç¯€é» newStartVNode å»èˆŠç¯€é»é™£åˆ—ä¸­æŸ¥æ‰¾ã€‚

[é»æ“Š] ç”¨ findIndex åœ¨èˆŠç¯€é»ä¸­æŸ¥æ‰¾èˆ‡ newStartVNode ç›¸åŒ key çš„ç¯€é»ã€‚

[é»æ“Š] å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±æŠŠå®ƒç§»å‹•åˆ°é ­éƒ¨ï¼Œç„¶å¾ŒæŠŠåŸæœ¬çš„ä½ç½®æ¨™è¨˜ç‚º undefinedï¼Œä»£è¡¨é€™å€‹ä½ç½®å·²ç¶“è™•ç†éäº†ã€‚

[é»æ“Š] æœ€å¾Œç§»å‹• newStartIdx åˆ°ä¸‹ä¸€å€‹ä½ç½®ï¼Œç¹¼çºŒä¸‹ä¸€è¼ªã€‚

ç‚ºä»€éº¼æ˜¯ç§»å‹•åˆ°é ­éƒ¨ï¼Ÿå› ç‚ºæˆ‘å€‘è™•ç†çš„æ˜¯ newStartVNodeï¼Œå®ƒåœ¨æ–°ç¯€é»é™£åˆ—çš„é ­éƒ¨ï¼Œæ‰€ä»¥è¦æŠŠå°æ‡‰çš„ DOM ç§»å‹•åˆ°ç•¶å‰çš„é ­éƒ¨ï¼Œä¹Ÿå°±æ˜¯ oldStartVNode.el å‰é¢ã€‚
-->

---

# æ¨™è¨˜å·²è™•ç†çš„ç¯€é»

<div class="mt-8 text-xl text-gray-300 mb-6">
ç§»å‹•å¾Œï¼Œéœ€è¦æŠŠèˆŠç¯€é»ä¸­çš„ä½ç½®æ¨™è¨˜ç‚º <code class="text-yellow-400">undefined</code>ï¼š
</div>

<div class="grid grid-cols-2 gap-8">
  <div>
    <div class="text-lg font-bold text-gray-400 mb-3">ç§»å‹•å‰</div>
    <div class="flex gap-2">
      <div class="px-4 py-2 bg-gray-800 border border-gray-600 rounded">p-1</div>
      <div class="px-4 py-2 bg-yellow-900/50 border border-yellow-500 rounded">p-2</div>
      <div class="px-4 py-2 bg-gray-800 border border-gray-600 rounded">p-3</div>
      <div class="px-4 py-2 bg-gray-800 border border-gray-600 rounded">p-4</div>
    </div>
  </div>

  <div v-click>
    <div class="text-lg font-bold text-gray-400 mb-3">ç§»å‹•å¾Œ</div>
    <div class="flex gap-2">
      <div class="px-4 py-2 bg-gray-800 border border-gray-600 rounded">p-1</div>
      <div class="px-4 py-2 bg-gray-700/30 border border-dashed border-gray-500 rounded text-gray-500">undefined</div>
      <div class="px-4 py-2 bg-gray-800 border border-gray-600 rounded">p-3</div>
      <div class="px-4 py-2 bg-gray-800 border border-gray-600 rounded">p-4</div>
    </div>
  </div>
</div>

<div v-click class="mt-8 p-4 bg-yellow-900/20 border-2 border-yellow-500/40 rounded-lg">
  <div class="text-xl text-yellow-300">
    <span class="font-bold">ç‚ºä»€éº¼è¦æ¨™è¨˜ï¼Ÿ</span><br>
    <span class="text-gray-300">é¿å…å¾ŒçºŒæ¯”è¼ƒæ™‚é‡è¤‡è™•ç†å·²ç¶“ç§»å‹•éçš„ç¯€é»</span>
  </div>
</div>

<!--
é€™é‚Šæœ‰å€‹é‡é»ï¼šç§»å‹•ä¹‹å¾Œï¼Œè¦æŠŠèˆŠç¯€é»ä¸­åŸæœ¬çš„ä½ç½®æ¨™è¨˜ç‚º undefinedã€‚

[é»æ“Š] ä½ çœ‹ï¼Œç§»å‹•å‰ p-2 åœ¨ç´¢å¼• 1 çš„ä½ç½®ï¼Œç§»å‹•å¾Œé€™å€‹ä½ç½®å°±è®Šæˆ undefined äº†ã€‚

[é»æ“Š] ç‚ºä»€éº¼è¦é€™æ¨£åšï¼Ÿå› ç‚ºé€™æ¨£å¯ä»¥é¿å…å¾ŒçºŒæ¯”è¼ƒæ™‚é‡è¤‡è™•ç†å·²ç¶“ç§»å‹•éçš„ç¯€é»ã€‚å¦‚æœä¸æ¨™è¨˜ï¼Œä¹‹å¾Œéæ­·åˆ°é€™å€‹ä½ç½®æ™‚å¯èƒ½æœƒå†è™•ç†ä¸€æ¬¡ï¼Œé€ æˆéŒ¯èª¤ã€‚
-->

---

# è™•ç† undefined

<div class="mt-8 text-xl text-gray-300 mb-6">
åœ¨å¾ªç’°ä¸­é‡åˆ° <code class="text-yellow-400">undefined</code> æ™‚è¦è·³éï¼š
</div>

<div class="bg-gray-800/50 rounded-lg p-6">

```js {all|2-5|6-9|10-12|all}{lines:true}
while (oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx) {
  if (!oldStartVNode) {
    // oldStart æ˜¯ undefinedï¼Œè·³é
    oldStartVNode = oldChildren[++oldStartIdx]
  }
  else if (!oldEndVNode) {
    // oldEnd æ˜¯ undefinedï¼Œè·³é
    oldEndVNode = oldChildren[--oldEndIdx]
  }
  else if (oldStartVNode.key === newStartVNode.key) {
    // ... æ­£å¸¸çš„å››æ­¥æ¯”è¼ƒ
  }
}
```

</div>

<!--
æ—¢ç„¶æœ‰äº›ä½ç½®æœƒè®Šæˆ undefinedï¼Œé‚£åœ¨è¿´åœˆä¸­é‡åˆ°çš„æ™‚å€™è¦æ€éº¼è™•ç†ï¼Ÿç­”æ¡ˆæ˜¯è·³éã€‚

[é»æ“Š] å¦‚æœ oldStartVNode æ˜¯ undefinedï¼Œå°±è·³åˆ°ä¸‹ä¸€å€‹ã€‚

[é»æ“Š] å¦‚æœ oldEndVNode æ˜¯ undefinedï¼Œå°±è·³åˆ°å‰ä¸€å€‹ã€‚

é€™å…©å€‹æª¢æŸ¥è¦æ”¾åœ¨å››æ­¥æ¯”è¼ƒä¹‹å‰ã€‚
-->

---

# å®Œæ•´çš„éç†æƒ³ç‹€æ³è™•ç†æµç¨‹

<div class="mt-8">
  <div class="space-y-4">
    <div v-click class="flex items-center gap-4">
      <div class="w-10 h-10 rounded-full bg-cyan-600 flex items-center justify-center text-xl font-bold">1</div>
      <div class="text-xl text-gray-300">å››æ­¥æ¯”è¼ƒéƒ½æ²’å‘½ä¸­</div>
    </div>
    <div v-click class="flex items-center gap-4">
      <div class="w-10 h-10 rounded-full bg-yellow-600 flex items-center justify-center text-xl font-bold">2</div>
      <div class="text-xl text-gray-300">æ‹¿ <code class="text-green-400">newStartVNode</code> å»èˆŠç¯€é»ä¸­æŸ¥æ‰¾</div>
    </div>
    <div v-click class="flex items-center gap-4">
      <div class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center text-xl font-bold">3</div>
      <div class="text-xl text-gray-300">æ‰¾åˆ° â†’ ç§»å‹•åˆ°é ­éƒ¨ï¼ŒåŸä½ç½®æ¨™è¨˜ç‚º <code class="text-yellow-400">undefined</code></div>
    </div>
    <div v-click class="flex items-center gap-4">
      <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-xl font-bold">4</div>
      <div class="text-xl text-gray-300">ç§»å‹• <code class="text-green-400">newStartIdx</code>ï¼Œé€²å…¥ä¸‹ä¸€è¼ª</div>
    </div>
  </div>
</div>

<div v-click class="mt-8 text-center text-xl text-yellow-300">
é‚£å¦‚æœåœ¨èˆŠç¯€é»ä¸­æ‰¾ä¸åˆ°å‘¢ï¼Ÿ ğŸ¤”
</div>

<!--
å¥½ï¼Œè®“æˆ‘å€‘æ•´ç†ä¸€ä¸‹å®Œæ•´çš„è™•ç†æµç¨‹ï¼š

[é»æ“Š] ç¬¬ä¸€æ­¥ï¼šå››æ­¥æ¯”è¼ƒéƒ½æ²’å‘½ä¸­ã€‚

[é»æ“Š] ç¬¬äºŒæ­¥ï¼šæ‹¿ newStartVNode å»èˆŠç¯€é»ä¸­ç”¨ findIndex æŸ¥æ‰¾ã€‚

[é»æ“Š] ç¬¬ä¸‰æ­¥ï¼šå¦‚æœæ‰¾åˆ°äº†ï¼Œå°±æŠŠå®ƒç§»å‹•åˆ°é ­éƒ¨ï¼Œç„¶å¾ŒæŠŠåŸä½ç½®æ¨™è¨˜ç‚º undefinedã€‚

[é»æ“Š] ç¬¬å››æ­¥ï¼šç§»å‹• newStartIdx å¾€å¾Œä¸€æ ¼ï¼Œé€²å…¥ä¸‹ä¸€è¼ªæ¯”è¼ƒã€‚

[é»æ“Š] ä¸éé€™é‚Šæœ‰å€‹å•é¡Œï¼šå¦‚æœåœ¨èˆŠç¯€é»ä¸­æ‰¾ä¸åˆ°æ€éº¼è¾¦ï¼Ÿé€™å°±æ˜¯ä¸‹ä¸€ç¯€è¦è™•ç†çš„ã€Œæ·»åŠ æ–°å…ƒç´ ã€çš„æƒ…æ³ã€‚
-->

---
clicks: 18
---

# å‹•ç•«æ¼”ç¤º

<DiffAnimationNonIdeal :clicks="$clicks" />

<!--
å¥½ï¼Œè®“æˆ‘å€‘ç”¨å‹•ç•«ä¾†å¯¦éš›æ¼”ç¤ºä¸€æ¬¡éç†æƒ³ç‹€æ³çš„è™•ç†éç¨‹ã€‚

èˆŠå­ç¯€é»æ˜¯ p-1ã€p-2ã€p-3ã€p-4ï¼Œæ–°å­ç¯€é»æ˜¯ p-2ã€p-4ã€p-1ã€p-3ã€‚

é€™å€‹ä¾‹å­åœ¨ç¬¬ä¸€è¼ªå°±æœƒè§¸ç™¼éç†æƒ³ç‹€æ³ï¼Œå››æ­¥æ¯”è¼ƒéƒ½æ²’å‘½ä¸­ã€‚

å‹•ç•«ä¸­é»ƒè‰²é–ƒçˆä»£è¡¨åœ¨èˆŠç¯€é»ä¸­æŸ¥æ‰¾ï¼Œundefined ä»£è¡¨å·²ç§»å‹•çš„ç¯€é»è¢«æ¨™è¨˜ã€‚

é»æ“Šæˆ–æŒ‰ç©ºæ ¼éµï¼Œè·Ÿè‘—å‹•ç•«çœ‹éç†æƒ³ç‹€æ³æ˜¯æ€éº¼è™•ç†çš„ã€‚
-->

---
layout: center
---

# å°çµ

<div class="mt-12 space-y-6 text-xl">
  <div v-click class="p-4 bg-gray-800/50 rounded-lg">
    <span class="text-cyan-400 font-bold">éç†æƒ³ç‹€æ³ï¼š</span>
    <span class="text-gray-300">å››æ­¥æ¯”è¼ƒéƒ½æ²’å‘½ä¸­æ™‚çš„è™•ç†</span>
  </div>

  <div v-click class="p-4 bg-gray-800/50 rounded-lg">
    <span class="text-yellow-400 font-bold">è§£æ±ºæ–¹æ¡ˆï¼š</span>
    <span class="text-gray-300">åœ¨èˆŠç¯€é»ä¸­æŸ¥æ‰¾ newStartVNode</span>
  </div>

  <div v-click class="p-4 bg-gray-800/50 rounded-lg">
    <span class="text-green-400 font-bold">æ¨™è¨˜è™•ç†ï¼š</span>
    <span class="text-gray-300">å·²ç§»å‹•çš„ç¯€é»æ¨™è¨˜ç‚º undefined ä¸¦è·³é</span>
  </div>
</div>

<div v-click class="mt-12 text-center text-2xl text-yellow-300">
ä¸‹ä¸€ç¯€ï¼šæ·»åŠ æ–°å…ƒç´ èˆ‡ç§»é™¤èˆŠå…ƒç´ 
</div>

<!--
ä¾†åšå€‹å°çµã€‚

[é»æ“Š] éç†æƒ³ç‹€æ³å°±æ˜¯å››æ­¥æ¯”è¼ƒéƒ½æ²’å‘½ä¸­çš„æƒ…æ³ã€‚

[é»æ“Š] è§£æ±ºæ–¹æ¡ˆæ˜¯åœ¨èˆŠç¯€é»ä¸­æŸ¥æ‰¾ newStartVNodeï¼Œæ‰¾åˆ°å°±ç§»å‹•åˆ°é ­éƒ¨ã€‚

[é»æ“Š] å·²ç§»å‹•çš„ç¯€é»è¦æ¨™è¨˜ç‚º undefinedï¼Œå¾ŒçºŒé‡åˆ°æ™‚è¦è·³éã€‚

[é»æ“Š] ä¸‹ä¸€ç¯€æˆ‘å€‘ä¾†çœ‹å¦‚ä½•è™•ç†æ·»åŠ æ–°å…ƒç´ å’Œç§»é™¤èˆŠå…ƒç´ ã€‚
-->
