---
layout: center
---

# éç†æƒ³ç‹€æ³çš„è™•ç†

<div class="mt-8 text-2xl text-gray-400">
å››æ­¥æ¯”è¼ƒéƒ½æ²’å‘½ä¸­æ€éº¼è¾¦ï¼Ÿ
</div>

<!--
å‰é¢æˆ‘å€‘å­¸ç¿’äº†é›™ç«¯ Diff çš„å››æ­¥æ¯”è¼ƒï¼Œä½†å¦‚æœå››æ­¥éƒ½æ²’æœ‰å‘½ä¸­å‘¢ï¼Ÿé€™å°±æ˜¯éç†æƒ³ç‹€æ³ã€‚
-->

---
clicks: 4
---

# å•é¡Œï¼šå››æ­¥éƒ½æ²’å‘½ä¸­

<div class="mt--2">
  <DiffAnimationNonIdeal :clicks="$clicks" />
</div>

<div v-click="4" class="mt-2 text-center text-3xl text-red-400 font-bold">
å››æ­¥éƒ½æ²’å‘½ä¸­ï¼æ€éº¼è¾¦ï¼Ÿ
</div>

<!--
è®“æˆ‘å€‘çœ‹ä¸€å€‹ä¾‹å­ã€‚èˆŠå­ç¯€é»æ˜¯ p-1ã€p-2ã€p-3ã€p-4ï¼Œæ–°å­ç¯€é»æ˜¯ p-2ã€p-4ã€p-1ã€p-3ã€‚

[é»æ“Š] ç¬¬ä¸€è¼ªæ¯”è¼ƒï¼š
- æ­¥é©Ÿä¸€ï¼šp-2 vs p-1ï¼Œä¸ç›¸ç­‰
- æ­¥é©ŸäºŒï¼šp-3 vs p-4ï¼Œä¸ç›¸ç­‰
- æ­¥é©Ÿä¸‰ï¼šp-3 vs p-1ï¼Œä¸ç›¸ç­‰
- æ­¥é©Ÿå››ï¼šp-2 vs p-4ï¼Œä¸ç›¸ç­‰

[é»æ“Š] å››æ­¥éƒ½æ²’å‘½ä¸­ï¼é€™å°±æ˜¯éç†æƒ³ç‹€æ³ï¼Œæˆ‘å€‘éœ€è¦é¡å¤–çš„è™•ç†ã€‚
-->

---

# è§£æ±ºæ–¹æ¡ˆï¼šåœ¨èˆŠç¯€é»ä¸­æŸ¥æ‰¾

<div class="mt-8 text-xl text-gray-300 mb-6">
æ‹¿æ–°çš„é ­éƒ¨ç¯€é» <code class="text-green-400">newStartVNode</code> å»èˆŠç¯€é»é™£åˆ—ä¸­æŸ¥æ‰¾ï¼š
</div>

<div class="bg-gray-800/50 rounded-lg p-6">

```js {all|2-5|7-14|16}{lines:true}
else {
  // å››æ­¥éƒ½æ²’å‘½ä¸­ï¼Œåœ¨èˆŠç¯€é»ä¸­æŸ¥æ‰¾
  const idxInOld = oldChildren.findIndex(
    node => node.key === newStartVNode.key
  )

  if (idxInOld > 0) {
    // æ‰¾åˆ°äº†ï¼Œç§»å‹•åˆ°é ­éƒ¨
    const vnodeToMove = oldChildren[idxInOld]
    patch(vnodeToMove, newStartVNode, container)
    insert(vnodeToMove.el, container, oldStartVNode.el)
    // æ¨™è¨˜ç‚ºå·²è™•ç†
    oldChildren[idxInOld] = undefined
  }

  newStartVNode = newChildren[++newStartIdx]
}
```

</div>

<!--
è§£æ±ºæ–¹æ¡ˆæ˜¯ï¼šæ‹¿æ–°çš„é ­éƒ¨ç¯€é»å»èˆŠç¯€é»é™£åˆ—ä¸­æŸ¥æ‰¾ã€‚

[é»æ“Š] ç”¨ findIndex åœ¨èˆŠç¯€é»ä¸­æŸ¥æ‰¾èˆ‡ newStartVNode ç›¸åŒ key çš„ç¯€é»

[é»æ“Š] å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±æŠŠå®ƒç§»å‹•åˆ°é ­éƒ¨ï¼Œç„¶å¾ŒæŠŠåŸä½ç½®æ¨™è¨˜ç‚º undefined

[é»æ“Š] æœ€å¾Œç§»å‹• newStartIdx åˆ°ä¸‹ä¸€å€‹ä½ç½®

ç‚ºä»€éº¼ç§»å‹•åˆ°é ­éƒ¨ï¼Ÿ

å› ç‚ºæˆ‘å€‘è™•ç†çš„æ˜¯ `newStartVNode`ï¼Œå®ƒåœ¨æ–°ç¯€é»é™£åˆ—çš„é ­éƒ¨ä½ç½®ï¼Œæ‰€ä»¥è¦æŠŠå°æ‡‰çš„ DOM ç§»å‹•åˆ°ç•¶å‰ DOM çš„é ­éƒ¨ï¼ˆ`oldStartVNode.el` å‰é¢ï¼‰ï¼Œé€™æ¨£æ‰èƒ½è®“çœŸå¯¦ DOM çš„é †åºèˆ‡æ–°ç¯€é»é™£åˆ—ä¸€è‡´ã€‚
-->

---

# æ¨™è¨˜å·²è™•ç†çš„ç¯€é»

<div class="mt-8 text-xl text-gray-300 mb-6">
ç§»å‹•å¾Œï¼Œéœ€è¦æŠŠèˆŠç¯€é»ä¸­çš„ä½ç½®æ¨™è¨˜ç‚º <code class="text-yellow-400">undefined</code>ï¼š
</div>

<div class="grid grid-cols-2 gap-8">
  <div>
    <div class="text-lg font-bold text-gray-400 mb-3">ç§»å‹•å‰</div>
    <div class="flex gap-2">
      <div class="px-4 py-2 bg-gray-800 border border-gray-600 rounded">p-1</div>
      <div class="px-4 py-2 bg-yellow-900/50 border border-yellow-500 rounded">p-2</div>
      <div class="px-4 py-2 bg-gray-800 border border-gray-600 rounded">p-3</div>
      <div class="px-4 py-2 bg-gray-800 border border-gray-600 rounded">p-4</div>
    </div>
  </div>

  <div v-click>
    <div class="text-lg font-bold text-gray-400 mb-3">ç§»å‹•å¾Œ</div>
    <div class="flex gap-2">
      <div class="px-4 py-2 bg-gray-800 border border-gray-600 rounded">p-1</div>
      <div class="px-4 py-2 bg-gray-700/30 border border-dashed border-gray-500 rounded text-gray-500">undefined</div>
      <div class="px-4 py-2 bg-gray-800 border border-gray-600 rounded">p-3</div>
      <div class="px-4 py-2 bg-gray-800 border border-gray-600 rounded">p-4</div>
    </div>
  </div>
</div>

<div v-click class="mt-8 p-4 bg-yellow-900/20 border-2 border-yellow-500/40 rounded-lg">
  <div class="text-xl text-yellow-300">
    <span class="font-bold">ç‚ºä»€éº¼è¦æ¨™è¨˜ï¼Ÿ</span><br>
    <span class="text-gray-300">é¿å…å¾ŒçºŒæ¯”è¼ƒæ™‚é‡è¤‡è™•ç†å·²ç¶“ç§»å‹•éçš„ç¯€é»</span>
  </div>
</div>

<!--
ç§»å‹•å¾Œï¼Œéœ€è¦æŠŠèˆŠç¯€é»ä¸­çš„ä½ç½®æ¨™è¨˜ç‚º undefinedã€‚

[é»æ“Š] ç§»å‹•å‰ p-2 åœ¨ç´¢å¼• 1ï¼Œç§»å‹•å¾Œé€™å€‹ä½ç½®è®Šæˆ undefinedã€‚

[é»æ“Š] ç‚ºä»€éº¼è¦æ¨™è¨˜ï¼Ÿå› ç‚ºé€™æ¨£å¯ä»¥é¿å…å¾ŒçºŒæ¯”è¼ƒæ™‚é‡è¤‡è™•ç†å·²ç¶“ç§»å‹•éçš„ç¯€é»ã€‚
-->

---

# è™•ç† undefined

<div class="mt-8 text-xl text-gray-300 mb-6">
åœ¨å¾ªç’°ä¸­é‡åˆ° <code class="text-yellow-400">undefined</code> æ™‚è¦è·³éï¼š
</div>

<div class="bg-gray-800/50 rounded-lg p-6">

```js {all|2-4|5-7|8-10}{lines:true}
while (oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx) {
  if (!oldStartVNode) {
    // oldStart æ˜¯ undefinedï¼Œè·³é
    oldStartVNode = oldChildren[++oldStartIdx]
  }
  else if (!oldEndVNode) {
    // oldEnd æ˜¯ undefinedï¼Œè·³é
    oldEndVNode = oldChildren[--oldEndIdx]
  }
  else if (oldStartVNode.key === newStartVNode.key) {
    // ... æ­£å¸¸çš„å››æ­¥æ¯”è¼ƒ
  }
}
```

</div>

<div v-click class="mt-8 p-4 bg-blue-900/20 border-2 border-blue-500/40 rounded-lg">
  <div class="text-xl text-blue-300">
    <span class="font-bold">é—œéµé»ï¼š</span>åœ¨å››æ­¥æ¯”è¼ƒä¹‹å‰ï¼Œå…ˆæª¢æŸ¥æ˜¯å¦ç‚º undefined
  </div>
</div>

<!--
åœ¨å¾ªç’°ä¸­é‡åˆ° undefined æ™‚è¦è·³éï¼š

[é»æ“Š] å¦‚æœ oldStartVNode æ˜¯ undefinedï¼Œå°±è·³åˆ°ä¸‹ä¸€å€‹

[é»æ“Š] å¦‚æœ oldEndVNode æ˜¯ undefinedï¼Œå°±è·³åˆ°å‰ä¸€å€‹

[é»æ“Š] æª¢æŸ¥å®Œ undefined å¾Œï¼Œæ‰é€²è¡Œæ­£å¸¸çš„å››æ­¥æ¯”è¼ƒ

[é»æ“Š] é—œéµé»æ˜¯ï¼šåœ¨å››æ­¥æ¯”è¼ƒä¹‹å‰ï¼Œè¦å…ˆæª¢æŸ¥æ˜¯å¦ç‚º undefinedã€‚
-->

---

# å®Œæ•´çš„éç†æƒ³ç‹€æ³è™•ç†æµç¨‹

<div class="mt-8">
  <div class="space-y-4">
    <div v-click class="flex items-center gap-4">
      <div class="w-10 h-10 rounded-full bg-cyan-600 flex items-center justify-center text-xl font-bold">1</div>
      <div class="text-xl text-gray-300">å››æ­¥æ¯”è¼ƒéƒ½æ²’å‘½ä¸­</div>
    </div>
    <div v-click class="flex items-center gap-4">
      <div class="w-10 h-10 rounded-full bg-yellow-600 flex items-center justify-center text-xl font-bold">2</div>
      <div class="text-xl text-gray-300">æ‹¿ <code class="text-green-400">newStartVNode</code> å»èˆŠç¯€é»ä¸­æŸ¥æ‰¾</div>
    </div>
    <div v-click class="flex items-center gap-4">
      <div class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center text-xl font-bold">3</div>
      <div class="text-xl text-gray-300">æ‰¾åˆ° â†’ ç§»å‹•åˆ°é ­éƒ¨ï¼ŒåŸä½ç½®æ¨™è¨˜ç‚º <code class="text-yellow-400">undefined</code></div>
    </div>
    <div v-click class="flex items-center gap-4">
      <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-xl font-bold">4</div>
      <div class="text-xl text-gray-300">ç§»å‹• <code class="text-green-400">newStartIdx</code>ï¼Œé€²å…¥ä¸‹ä¸€è¼ª</div>
    </div>
  </div>
</div>

<div v-click class="mt-8 text-center text-xl text-yellow-300">
é‚£å¦‚æœåœ¨èˆŠç¯€é»ä¸­æ‰¾ä¸åˆ°å‘¢ï¼Ÿ ğŸ¤”
</div>

<!--
è®“æˆ‘å€‘ç¸½çµä¸€ä¸‹å®Œæ•´çš„éç†æƒ³ç‹€æ³è™•ç†æµç¨‹ï¼š

[é»æ“Š] ç¬¬ä¸€æ­¥ï¼šå››æ­¥æ¯”è¼ƒéƒ½æ²’å‘½ä¸­

[é»æ“Š] ç¬¬äºŒæ­¥ï¼šæ‹¿ newStartVNode å»èˆŠç¯€é»ä¸­æŸ¥æ‰¾

[é»æ“Š] ç¬¬ä¸‰æ­¥ï¼šå¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ç§»å‹•åˆ°é ­éƒ¨ï¼ŒåŸä½ç½®æ¨™è¨˜ç‚º undefined

[é»æ“Š] ç¬¬å››æ­¥ï¼šç§»å‹• newStartIdxï¼Œé€²å…¥ä¸‹ä¸€è¼ªæ¯”è¼ƒ

[é»æ“Š] é‚£å¦‚æœåœ¨èˆŠç¯€é»ä¸­æ‰¾ä¸åˆ°å‘¢ï¼Ÿé€™å°±æ˜¯ä¸‹ä¸€ç¯€è¦è™•ç†çš„ã€Œæ·»åŠ æ–°å…ƒç´ ã€çš„æƒ…æ³ã€‚
-->

---
clicks: 18
---

# å‹•ç•«æ¼”ç¤º

<DiffAnimationNonIdeal :clicks="$clicks" />

<!--
è®“æˆ‘å€‘é€šéå‹•ç•«ä¾†æ¼”ç¤ºéç†æƒ³ç‹€æ³çš„è™•ç†éç¨‹ã€‚

èˆŠå­ç¯€é»æ˜¯ p-1ã€p-2ã€p-3ã€p-4
æ–°å­ç¯€é»æ˜¯ p-2ã€p-4ã€p-1ã€p-3

é€™å€‹ä¾‹å­æœƒè§¸ç™¼éç†æƒ³ç‹€æ³ï¼šç¬¬ä¸€è¼ªçš„å››æ­¥æ¯”è¼ƒéƒ½æ²’å‘½ä¸­ã€‚

å‹•ç•«ä¸­æœƒå±•ç¤ºï¼š
- é»ƒè‰²é–ƒçˆï¼šåœ¨èˆŠç¯€é»ä¸­æŸ¥æ‰¾
- undefinedï¼šå·²ç§»å‹•çš„ç¯€é»è¢«æ¨™è¨˜

é»æ“Šæˆ–æŒ‰ç©ºæ ¼éµï¼Œè·Ÿè‘—å‹•ç•«ä¸€æ­¥æ­¥çœ‹éç†æƒ³ç‹€æ³æ˜¯å¦‚ä½•è™•ç†çš„ã€‚
-->

---
layout: center
---

# å°çµ

<div class="mt-12 space-y-6 text-xl">
  <div v-click class="p-4 bg-gray-800/50 rounded-lg">
    <span class="text-cyan-400 font-bold">éç†æƒ³ç‹€æ³ï¼š</span>
    <span class="text-gray-300">å››æ­¥æ¯”è¼ƒéƒ½æ²’å‘½ä¸­æ™‚çš„è™•ç†</span>
  </div>

  <div v-click class="p-4 bg-gray-800/50 rounded-lg">
    <span class="text-yellow-400 font-bold">è§£æ±ºæ–¹æ¡ˆï¼š</span>
    <span class="text-gray-300">åœ¨èˆŠç¯€é»ä¸­æŸ¥æ‰¾ newStartVNode</span>
  </div>

  <div v-click class="p-4 bg-gray-800/50 rounded-lg">
    <span class="text-green-400 font-bold">æ¨™è¨˜è™•ç†ï¼š</span>
    <span class="text-gray-300">å·²ç§»å‹•çš„ç¯€é»æ¨™è¨˜ç‚º undefined ä¸¦è·³é</span>
  </div>
</div>

<div v-click class="mt-12 text-center text-2xl text-yellow-300">
ä¸‹ä¸€ç¯€ï¼šæ·»åŠ æ–°å…ƒç´ èˆ‡ç§»é™¤èˆŠå…ƒç´ 
</div>

<!--
è®“æˆ‘å€‘ç¸½çµé€™ä¸€ç¯€çš„å…§å®¹ï¼š

[é»æ“Š] éç†æƒ³ç‹€æ³æ˜¯æŒ‡å››æ­¥æ¯”è¼ƒéƒ½æ²’å‘½ä¸­çš„æƒ…æ³

[é»æ“Š] è§£æ±ºæ–¹æ¡ˆæ˜¯åœ¨èˆŠç¯€é»ä¸­æŸ¥æ‰¾ newStartVNode

[é»æ“Š] å·²ç§»å‹•çš„ç¯€é»è¦æ¨™è¨˜ç‚º undefinedï¼Œå¾ŒçºŒé‡åˆ°æ™‚è·³é

[é»æ“Š] ä¸‹ä¸€ç¯€æˆ‘å€‘æœƒå­¸ç¿’å¦‚ä½•è™•ç†æ·»åŠ æ–°å…ƒç´ å’Œç§»é™¤èˆŠå…ƒç´ çš„æƒ…æ³ã€‚
-->
