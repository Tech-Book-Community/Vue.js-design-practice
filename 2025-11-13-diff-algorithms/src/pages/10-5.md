---
layout: center
---

# 移除不存在的元素

<div class="mt-8 text-2xl text-gray-400">
當舊子節點中有些元素在新子節點中不存在時
</div>

<!--
上一節我們學習了如何添加新元素，這一節我們來看相反的情況：移除不存在的元素。
-->

---
clicks: 6
---

# 問題：舊節點有剩餘

<DiffAnimationRemove :clicks="$clicks" />

<!--
讓我們看一個例子。

舊子節點是 p-1、p-2、p-3，新子節點是 p-1、p-3。

可以看到 p-2 在新子節點中不存在了，需要被移除。

點擊或按空格鍵查看動畫。
-->

---

# 為什麼會有剩餘？

<div class="mt-6">
  <div class="text-xl text-gray-300 mb-6">
    讓我們看看循環結束時的索引狀態：
  </div>

  <div class="grid grid-cols-2 gap-8">
    <div class="p-4 bg-gray-800/50 rounded-lg">
      <div class="text-lg font-bold text-gray-400 mb-3">新子節點索引</div>
      <div class="font-mono text-lg">
        <div class="flex gap-4 mb-2">
          <span class="text-cyan-400">newStartIdx = 2</span>
        </div>
        <div class="flex gap-4">
          <span class="text-orange-400">newEndIdx = 0</span>
        </div>
      </div>
      <div v-click class="mt-3 text-green-400 font-bold">
        newEndIdx < newStartIdx → 新節點處理完了！
      </div>
    </div>
    <div class="p-4 bg-gray-800/50 rounded-lg">
      <div class="text-lg font-bold text-gray-400 mb-3">舊子節點索引</div>
      <div class="font-mono text-lg">
        <div class="flex gap-4 mb-2">
          <span class="text-cyan-400">oldStartIdx = 1</span>
        </div>
        <div class="flex gap-4">
          <span class="text-orange-400">oldEndIdx = 1</span>
        </div>
      </div>
      <div v-click class="mt-3 text-yellow-400 font-bold">
        oldStartIdx <= oldEndIdx → 還有舊節點沒處理！
      </div>
    </div>
  </div>

  <div v-click class="mt-6 text-center text-2xl text-red-400 font-bold">
    索引 1 的 p-2 還在，但新節點中沒有它，需要卸載！
  </div>
</div>

<!--
讓我們看看循環結束時的索引狀態：

[點擊] 新子節點：newEndIdx 小於 newStartIdx，表示新節點都處理完了

[點擊] 舊子節點：oldStartIdx 等於 oldEndIdx，等於 1，表示還有舊節點沒處理

[點擊] 沒錯，索引 1 的 p-2 還在 DOM 中，但新節點裡沒有它，需要卸載！
-->

---

# 與添加新元素的對比

<div class="mt-8">
  <div class="grid grid-cols-2 gap-8">
    <div v-click class="p-6 bg-emerald-900/20 border-2 border-emerald-500/40 rounded-lg">
      <div class="text-xl text-emerald-300 font-bold mb-4">添加新元素</div>
      <div class="space-y-3 text-gray-300">
        <div class="flex items-start gap-2">
          <span class="text-emerald-400">•</span>
          <span><code>oldEndIdx < oldStartIdx</code></span>
        </div>
        <div class="flex items-start gap-2">
          <span class="text-emerald-400">•</span>
          <span><code>newStartIdx <= newEndIdx</code></span>
        </div>
        <div class="flex items-start gap-2">
          <span class="text-emerald-400">•</span>
          <span>舊的處理完，新的還有剩</span>
        </div>
        <div class="flex items-start gap-2">
          <span class="text-emerald-400">→</span>
          <span class="font-bold">掛載剩餘的新節點</span>
        </div>
      </div>
    </div>
    <div v-click class="p-6 bg-red-900/20 border-2 border-red-500/40 rounded-lg">
      <div class="text-xl text-red-300 font-bold mb-4">移除舊元素</div>
      <div class="space-y-3 text-gray-300">
        <div class="flex items-start gap-2">
          <span class="text-red-400">•</span>
          <span><code>newEndIdx < newStartIdx</code></span>
        </div>
        <div class="flex items-start gap-2">
          <span class="text-red-400">•</span>
          <span><code>oldStartIdx <= oldEndIdx</code></span>
        </div>
        <div class="flex items-start gap-2">
          <span class="text-red-400">•</span>
          <span>新的處理完，舊的還有剩</span>
        </div>
        <div class="flex items-start gap-2">
          <span class="text-red-400">→</span>
          <span class="font-bold">卸載剩餘的舊節點</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div v-click class="mt-8 p-4 bg-blue-900/20 border-2 border-blue-500/40 rounded-lg text-center">
  <div class="text-xl text-blue-300">
    兩者互為<span class="font-bold">鏡像</span>：一個是新多舊少，一個是舊多新少
  </div>
</div>

<!--
讓我們對比添加新元素和移除舊元素：

[點擊] 添加新元素：舊節點處理完，新節點還有剩，需要掛載

[點擊] 移除舊元素：新節點處理完，舊節點還有剩，需要卸載

[點擊] 兩者互為鏡像，條件判斷正好相反。
-->

---

# 循環結束後的檢查

<div class="mt-6 text-xl text-gray-300 mb-4">
完整的循環結束後處理邏輯：
</div>

<div class="bg-gray-800/50 rounded-lg p-5">

````md magic-move
```js {all}{lines:true}
while (oldStartIdx < oldEndIdx && newStartIdx <= newEndIdx) {
  // 省略
}

if (oldEndIdx < oldStartIdx && newStartIdx <= newEndIdx) {
  // 添加新節點
} else if (newEndIdx < newStartIdx && oldStartIdx <= oldEndIdx) {
  // 移除舊節點
}
```
```js {all|2-6|7-11}{lines:true}
// 循環結束後
if (oldEndIdx < oldStartIdx && newStartIdx <= newEndIdx) {
  // 添加新節點
  for (let i = newStartIdx; i <= newEndIdx; i++) {
    patch(null, newChildren[i], container, oldStartVNode.el)
  }
} else if (newEndIdx < newStartIdx && oldStartIdx <= oldEndIdx) {
  // 移除舊節點
  for (let i = oldStartIdx; i <= oldEndIdx; i++) {
    unmount(oldChildren[i])
  }
}
```
````

</div>

<div v-click class="mt-2 grid grid-cols-2 gap-4">
  <div class="p-4 bg-emerald-900/20 border border-emerald-500/40 rounded-lg">
    <div class="text-emerald-300 font-bold mb-2">添加條件</div>
    <div class="text-sm text-gray-300">
      舊的交叉 + 新的沒交叉<br>
      → 遍歷新節點，逐一掛載
    </div>
  </div>
  <div class="p-4 bg-red-900/20 border border-red-500/40 rounded-lg">
    <div class="text-red-300 font-bold mb-2">移除條件</div>
    <div class="text-sm text-gray-300">
      新的交叉 + 舊的沒交叉<br>
      → 遍歷舊節點，逐一卸載
    </div>
  </div>
</div>

<!--
這是完整的循環結束後處理邏輯：

[點擊] 第一個 if：舊節點交叉了，新節點沒交叉，需要添加新節點

[點擊] 第二個 else if：新節點交叉了，舊節點沒交叉，需要移除舊節點

[點擊] 用「交叉」來記憶：誰交叉了就代表誰處理完了，沒交叉的那邊還有剩。
-->

---
clicks: 9
---

# 完整動畫

<DiffAnimationRemove :clicks="$clicks" />

---
layout: center
---

# 小結

<div class="mt-12 space-y-6 text-xl">
  <div v-click class="p-4 bg-gray-800/50 rounded-lg">
    <span class="text-red-400 font-bold">移除條件：</span>
    <span class="text-gray-300"><code>newEndIdx < newStartIdx && oldStartIdx <= oldEndIdx</code></span>
  </div>

  <div v-click class="p-4 bg-gray-800/50 rounded-lg">
    <span class="text-yellow-400 font-bold">含義：</span>
    <span class="text-gray-300">新節點處理完了，舊節點還有剩餘</span>
  </div>

  <div v-click class="p-4 bg-gray-800/50 rounded-lg">
    <span class="text-emerald-400 font-bold">操作：</span>
    <span class="text-gray-300">遍歷剩餘舊節點，調用 <code>unmount</code> 卸載</span>
  </div>
</div>

<div v-click class="mt-12 text-center text-2xl text-blue-300">
至此，雙端 Diff 算法的核心邏輯已經完整！
</div>

<!--
讓我們總結這一節的內容：

[點擊] 移除條件：新節點交叉，舊節點沒交叉

[點擊] 含義是：新節點處理完了，舊節點還有剩餘

[點擊] 操作是：遍歷剩餘舊節點，調用 unmount 卸載

[點擊] 至此，雙端 Diff 算法的核心邏輯已經完整！包含四步比較、非理想狀況、添加新元素、移除舊元素。
-->
